# 视频流传输优化 - Nginx X-Accel-Redirect

## 功能说明

为了减轻 Java 服务器在生产环境的压力，实现了两种视频传输模式：

### 开发环境模式
- **配置**：`video.use-nginx-accel=false`
- **行为**：Java 直接流式传输视频文件
- **优点**：无需 Nginx 配置，开发调试方便
- **缺点**：占用 Java 线程和内存

### 生产环境模式
- **配置**：`video.use-nginx-accel=true`
- **行为**：使用 Nginx X-Accel-Redirect
- **优点**：Nginx 接管文件传输，Java 只负责权限验证，大幅降低服务器压力
- **缺点**：需要配置 Nginx

## Nginx 配置

在 `nginx.conf` 中添加以下配置：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 代理到 Java 后端
    location /firework/ {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 内部重定向接口 (处理 X-Accel-Redirect)
    location /internal_video/ {
        internal;      # 只有 Nginx 内部能访问，外部返回 404
        alias /;       # 映射到根目录，可以访问任意绝对路径的文件

        # 优化大文件传输
        sendfile on;
        tcp_nopush on;
        aio on;        # 异步 IO，彻底解放 Nginx 线程
    }
}
```

## 工作原理

### 开发环境流程
1. 前端请求：`GET /admin/video/stream/{videoId}`
2. Java 验证权限和文件存在性
3. Java 使用 `RandomAccessFile` 读取文件并流式传输
4. 支持 HTTP Range 请求（断点续传）

### 生产环境流程
1. 前端请求：`GET /admin/video/stream/{videoId}`
2. Java 验证权限和文件存在性
3. Java 返回空响应体 + 特殊响应头：
   ```
   X-Accel-Redirect: /internal_video/path/to/video.mp4
   X-Accel-Buffering: no
   ```
4. Nginx 接收到响应头后，接管文件传输
5. Nginx 从 `/internal_video/path/to/video.mp4` 读取文件并传输给客户端
6. Nginx 自动处理 Range 请求、缓存、压缩等

## 配置切换

### 开发环境
`application.properties`:
```properties
video.use-nginx-accel=false
```

### 生产环境
启动时指定 profile：
```bash
java -jar app.jar --spring.profiles.active=prod
```

或在 `application-prod.properties` 中：
```properties
video.use-nginx-accel=true
```

## 性能对比

| 指标 | 开发模式 (Java) | 生产模式 (Nginx) |
|------|----------------|------------------|
| Java 线程占用 | 高 | 极低 |
| 内存占用 | 中等 | 极低 |
| CPU 占用 | 中等 | 低 |
| 并发能力 | 受限于 Java 线程池 | 高（Nginx 异步 IO） |
| Range 请求支持 | ✅ | ✅ |
| 断点续传 | ✅ | ✅ |

## 注意事项

1. **文件路径**：确保 Nginx 有权限访问视频文件路径
2. **安全性**：`/internal_video/` 必须设置为 `internal`，防止外部直接访问
3. **路径映射**：`alias /` 表示映射到根目录，如果视频在其他目录，需要调整
4. **日志监控**：生产环境建议监控 Nginx 和 Java 日志，确保 X-Accel-Redirect 正常工作

## 验证方法

### 开发环境验证
```bash
curl -I http://localhost:8080/firework/admin/video/stream/{videoId}
```
应该看到：
- `Content-Type: video/mp4`
- `Accept-Ranges: bytes`
- 有实际的 `Content-Length`

### 生产环境验证
```bash
curl -I http://your-domain.com/firework/admin/video/stream/{videoId}
```
应该看到：
- `Content-Type: video/mp4`
- `Accept-Ranges: bytes`
- 响应速度更快
- Java 日志显示：`Using Nginx X-Accel-Redirect`

## 故障排查

### 问题1：生产环境视频无法播放
- 检查 Nginx 配置中 `internal_video` location 是否正确
- 检查 Nginx 是否有权限访问视频文件
- 查看 Nginx error.log

### 问题2：Java 日志显示使用 Nginx 但实际是 Java 传输
- 检查 `video.use-nginx-accel` 配置是否生效
- 检查 Spring Profile 是否正确激活

### 问题3：404 错误
- 检查视频文件路径是否正确
- 检查 `alias /` 配置是否正确

---

**修改日期**：2026-01-27  
**作者**：Harlan

